# Workflow to receive binaries from private codelayers repo and create public releases
name: Receive Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version tag (e.g., v0.0.5)'
        required: true
        type: string
      sha256_mac_arm:
        description: 'SHA256 checksum of macOS ARM64 binary'
        required: true
        type: string
      sha256_linux_x86:
        description: 'SHA256 checksum of Linux x86_64 binary'
        required: true
        type: string
      sha256_linux_arm:
        description: 'SHA256 checksum of Linux ARM64 binary'
        required: true
        type: string

permissions:
  contents: write

jobs:
  create-release:
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4

      - name: Download binaries from private repo
        env:
          GH_TOKEN: ${{ secrets.CODELAYERS_RELEASE_TOKEN }}
        run: |
          mkdir -p artifacts

          # Download all platform binaries from the private repo release
          gh release download "${{ inputs.version }}" \
            --repo codelayers-ai/codelayers \
            --pattern "codelayers-cli-aarch64-apple-darwin.tar.xz" \
            --pattern "codelayers-cli-x86_64-unknown-linux-gnu.tar.xz" \
            --pattern "codelayers-cli-aarch64-unknown-linux-gnu.tar.xz" \
            --dir ./artifacts

          # Download the shell installer
          gh release download "${{ inputs.version }}" \
            --repo codelayers-ai/codelayers \
            --pattern "codelayers-cli-installer.sh" \
            --dir ./artifacts

          # Verify checksums
          cd artifacts
          echo "${{ inputs.sha256_mac_arm }}  codelayers-cli-aarch64-apple-darwin.tar.xz" | sha256sum -c -
          echo "${{ inputs.sha256_linux_x86 }}  codelayers-cli-x86_64-unknown-linux-gnu.tar.xz" | sha256sum -c -
          echo "${{ inputs.sha256_linux_arm }}  codelayers-cli-aarch64-unknown-linux-gnu.tar.xz" | sha256sum -c -

      - name: Create GitHub Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VERSION="${{ inputs.version }}"

          # Create release notes
          cat > notes.txt << 'EOF'
          ## Install codelayers CLI

          ### Homebrew (recommended)
          ```sh
          brew install codelayers-ai/tap/codelayers
          ```

          ### Shell installer
          ```sh
          curl --proto '=https' --tlsv1.2 -LsSf https://github.com/codelayers-ai/homebrew-tap/releases/latest/download/codelayers-cli-installer.sh | sh
          ```

          ### Manual download
          Download the binary for your platform from the assets below.

          | Platform | Binary |
          |----------|--------|
          | macOS ARM64 (Apple Silicon) | `codelayers-cli-aarch64-apple-darwin.tar.xz` |
          | Linux x86_64 | `codelayers-cli-x86_64-unknown-linux-gnu.tar.xz` |
          | Linux ARM64 | `codelayers-cli-aarch64-unknown-linux-gnu.tar.xz` |
          EOF

          # Create release (or update if exists)
          gh release create "$VERSION" \
            --title "codelayers $VERSION" \
            --notes-file notes.txt \
            ./artifacts/* \
            || gh release upload "$VERSION" ./artifacts/* --clobber

      - name: Update Homebrew formula
        run: |
          VERSION="${{ inputs.version }}"
          VERSION_NUM="${VERSION#v}"  # Remove 'v' prefix
          SHA256_MAC_ARM="${{ inputs.sha256_mac_arm }}"
          SHA256_LINUX_X86="${{ inputs.sha256_linux_x86 }}"
          SHA256_LINUX_ARM="${{ inputs.sha256_linux_arm }}"

          cat > Formula/codelayers.rb << EOF
          class Codelayers < Formula
            desc "Zero-knowledge code visualization CLI for Vision Pro"
            homepage "https://codelayers.ai"
            version "$VERSION_NUM"
            license "MIT"

            if OS.mac? && Hardware::CPU.arm?
              url "https://github.com/codelayers-ai/homebrew-tap/releases/download/$VERSION/codelayers-cli-aarch64-apple-darwin.tar.xz"
              sha256 "$SHA256_MAC_ARM"
            elsif OS.linux? && Hardware::CPU.intel?
              url "https://github.com/codelayers-ai/homebrew-tap/releases/download/$VERSION/codelayers-cli-x86_64-unknown-linux-gnu.tar.xz"
              sha256 "$SHA256_LINUX_X86"
            elsif OS.linux? && Hardware::CPU.arm?
              url "https://github.com/codelayers-ai/homebrew-tap/releases/download/$VERSION/codelayers-cli-aarch64-unknown-linux-gnu.tar.xz"
              sha256 "$SHA256_LINUX_ARM"
            end

            def install
              bin.install "codelayers"
            end
          end
          EOF

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add Formula/codelayers.rb
          git commit -m "codelayers $VERSION_NUM"
          git push

      - name: Trigger Docker image build
        env:
          GH_TOKEN: ${{ secrets.CODELAYERS_RELEASE_TOKEN }}
        run: |
          gh workflow run docker.yml \
            --repo codelayers-ai/codelayers-action \
            --field version="${{ inputs.version }}"
          echo "Triggered Docker image build for ${{ inputs.version }}"
